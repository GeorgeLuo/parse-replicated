# parse-replicated

Parse-replicated is a cli tool to extract information from a support bundle generated by replicated:

- Host OS
- Host OS version
- Number of cores
- Load average in seconds over the past 15 minutes
- Disk usage in bytes on the root device
- Docker version
- Docker storage driver

## Design

A locations object is used to map the files where the details are contained to the parameters of interest.

```
var locations = map[string]*environment.FileParams{
	"default/proc/cpuinfo":               &environment.FileParams{ParseForParams: []string{"cpu cores"}, Format: "cpuinfo"},
	"default/commands/loadavg/loadavg":   &environment.FileParams{ParseForParams: []string{"loadAvg"}, Format: "loadavg"},
	"default/commands/df/stdout":         &environment.FileParams{ParseForParams: []string{"diskUsage"}, Format: "df"},
	"default/docker/docker_version.json": &environment.FileParams{ParseForParams: []string{"Version"}, Format: "json"},
	"default/docker/docker_info.json":    &environment.FileParams{ParseForParams: []string{"Driver", "OperatingSystem"}, Format: "json"},
}
```

The key of the map is the string file path and the ParseForParams contains the parameter to parse for and the file format. The code is organized in a way (environment/utils.go) that adding additional code for unaccounted schemas is relatively painless by making additions to the locations object and implementing parsing functions.

The program will attempt to parse the entire request and output errors at completion. There is no attempt to omit the fields that are unpopulated. The program will exit if the original bundle is malformed.

## Usage

A Dockerfile.dev is included to generate an environment to test the code.

```
sudo docker build -t parse-replicated --file Dockerfile.dev .
sudo docker run --volume "$(pwd)":/go/src/github.com/GeorgeLuo/parse-replicated --interactive --tty --net=host parse-replicated
```

Within the environment,
```
go run main.go supportbundle.tar.gz
```
The supportbundle.tar.gz being the provided bundle in this repo. You may direct the program towards any such bundle.

The following command can be run to generate additional bundles:

```bash
docker run -it --rm \
    --name support-bundle \
    -v $PWD:/out \
    -v /var/run/docker.sock:/var/run/docker.sock \
    --net host --pid host -w /out  \
    -e HTTP_PROXY -e HTTPS_PROXY -e NO_PROXY \
    replicated/support-bundle \
    generate --no-upload
```

The output with the test bundle should display
```
{"host_os":"Ubuntu","host_os_version":"18.04.2 LTS","num_cores":8,"load_average":0.05,"disk_usage":10252964,"docker_version":"18.09.6","docker_storage_driver":"overlay2"}
```
This is a json representation of the requested parameters from above.

## Future Considerations

There should be an effort to develop tests for each of the parsing functions. This would involve including sample valid/invalid text bodies to run against.

There should be a schema parser to populate the location map from a file. It might be worth looking into a refactor of the parsing caller, as a file may be reopened continuously until all fields of the file are found. I did not prioritize handling this as the file sizes of the bundle are relatively small and limited in scope.

For the same reason, I did not optimize run-time by parallelizing the parsing of the different files with go-rountines. This would also add concurrency implications with writing the response object. The errors could be fleshed out by including positions where the parsing failed.
